name: Python Code Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  check:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check Python syntax
      run: |
        python -m py_compile main.py
        python -m py_compile app/*.py
        python -m py_compile app/services/*.py
        python -m py_compile app/ui/*.py

    - name: Check imports
      run: |
        python -c "from app.db import Database; print('‚úÖ db.py')"
        python -c "from app.models import Book; print('‚úÖ models.py')"
        python -c "from app.services.library_service import LibraryService; print('‚úÖ library_service.py')"
        python -c "from app.services.pdf_service import PdfService; print('‚úÖ pdf_service.py')"
        python -c "from app.ui.main_window import MainWindow; print('‚úÖ main_window.py')"
        python -c "from app.ui.theme import get_theme_stylesheet; print('‚úÖ theme.py')"

    - name: Check project structure
      run: |
        test -f README.md && echo "‚úÖ README.md exists"
        test -f LICENSE && echo "‚úÖ LICENSE exists"
        test -f requirements.txt && echo "‚úÖ requirements.txt exists"
        test -f CONTRIBUTING.md && echo "‚úÖ CONTRIBUTING.md exists"
      shell: bash

    - name: Verify README completeness
      run: |
        grep -q "–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏" README.md && echo "‚úÖ Features section exists"
        grep -q "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞" README.md && echo "‚úÖ Architecture section exists"
        grep -q "–£—Å—Ç–∞–Ω–æ–≤–∫–∞" README.md && echo "‚úÖ Installation section exists"
      shell: bash

    - name: Count lines of code
      run: |
        echo "üìä Project Statistics:"
        echo "Python files:"
        find . -name "*.py" -not -path "./.venv/*" -not -path "./__pycache__/*" | wc -l
        echo "Lines of code:"
        find . -name "*.py" -not -path "./.venv/*" -not -path "./__pycache__/*" -exec wc -l {} + | tail -1
      shell: bash

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8

    - name: Lint with flake8 (warnings only)
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=.venv,__pycache__
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics --exclude=.venv,__pycache__
      continue-on-error: true
